<template>
  <GitCommit v-if="activeTab === 'git_commit'" :folderPath="folderPath" :selectedFile="selectedFile" :active-tab="activeTab" :sidebar="sidebar" :shareEmail="shareEmail" />

  <BaseLayout v-else :share-email="shareEmail" :sidebar="sidebar">
    <template v-slot:navbar="{ collapsed, collapse }">
      <NavBar :sidebar="sidebar" :collapsed="collapsed" @collapse="collapse">
        <NavSearch />
        <NavTabs :folder-path="folderPath" :activeTab="activeTab" :selectedFile="selectedFile" :selectedFolder="selectedFolder" @sync="syncSingle" />
      </NavBar>
    </template>

    <template v-slot:sidebar="{ collapse }">
      <FilesTree :folder-path="folderPath" :not-registered="notRegistered" v-if="sidebar" @collapse="collapse" @sync="syncSingle" ref="filesTree" />
    </template>

    <template v-slot:default>
      <NotRegistered v-if="notRegistered" />

      <ChangesViewer v-if="activeTab === 'sync'" :selected-file="selectedFile" :activeTab="activeTab" @sync="syncSingle" @transform="transformSingle" />
      <GitLog v-if="activeTab === 'git_log'" :folderPath="folderPath" :selectedFile="selectedFile" :active-tab="activeTab" />
      <GitSettings v-if="activeTab === 'git_settings'" :active-tab="activeTab" />

      <DriveTools v-if="activeTab === 'drive_tools'" :folderPath="folderPath" :selectedFile="selectedFile" :selected-folder="selectedFolder" :active-tab="activeTab" />
      <LogsViewer v-if="activeTab === 'drive_logs'" :active-tab="activeTab" />
      <UserSettings v-if="activeTab === 'drive_config' || activeTab === 'drive_config_git'" :activeTab="activeTab" />

      <div v-if="(activeTab === 'html' || activeTab === 'markdown' || activeTab === 'drive_backlinks') && selectedFile.mimeType === 'text/x-markdown'">
        <FilePreview :folder-path="folderPath" :activeTab="activeTab" :selectedFile="selectedFile" />
      </div>
      <div v-if="(activeTab === 'html' || activeTab === 'markdown' || activeTab === 'drive_backlinks') && selectedFile.mimeType === 'image/svg+xml'">
        <ImagePreview :folder-path="folderPath" :activeTab="activeTab" :selectedFile="selectedFile" />
      </div>
      <div v-if="(activeTab === 'html') && selectedFile.mimeType === 'application/binary'">
        <IframePreview :folder-path="folderPath" :activeTab="activeTab" :selectedFile="selectedFile" />
      </div>

      <DriveTools v-if="(!activeTab || activeTab === 'html') && !selectedFile.id"
                  :folderPath="folderPath"
                  :selectedFile="selectedFile"
                  :selected-folder="selectedFolder"
                  :active-tab="activeTab"
                  :tree-empty="treeEmpty"
                  :tree-regenerate="treeRegenerate"
      />

    </template>
  </BaseLayout>
</template>
<script lang="ts">
import BaseLayout from '../layout/BaseLayout.vue';
import {DEFAULT_TAB, UiMixin} from '../components/UiMixin.mjs';
import FilesTree from '../components/FilesTree.vue';
import {UtilsMixin} from '../components/UtilsMixin.mjs';
import NotRegistered from './NotRegistered.vue';
import FilePreview from '../components/FilePreview.vue';
import ImagePreview from '../components/ImagePreview.vue';
import IframePreview from '../components/IframePreview.vue';
import NavTabs from '../components/NavTabs.vue';
import NavSearch from '../components/NavSearch.vue';
import LogsViewer from '../components/LogsViewer.vue';
import ChangesViewer from '../components/ChangesViewer.vue';
import UserSettings from '../components/UserSettings.vue';
import GitLog from '../components/GitLog.vue';
import GitCommit from '../components/GitCommit.vue';
import DriveTools from '../components/DriveTools.vue';
import NavBar from '../components/NavBar.vue';
import GitSettings from '../components/GitSettings.vue';

export default {
  name: 'FolderView',
  components: {
    GitSettings,
    NavBar,
    DriveTools,
    NavTabs,
    NavSearch,
    NotRegistered,
    FilesTree,
    BaseLayout,
    FilePreview,
    ImagePreview,
    IframePreview,
    LogsViewer,
    ChangesViewer,
    UserSettings,
    GitLog,
    GitCommit
  },
  mixins: [ UtilsMixin, UiMixin ],
  data() {
    return {
      rootFolder: {},
      folderPath: '',
      activeTab: DEFAULT_TAB,
      files: [],
      selectedFile: {},
      selectedFolder: {},
      treeEmpty: false,
      treeRegenerate: false
    };
  },
  computed: {
    sidebar() {
      if (this.notRegistered) {
        return false;
      }
      return this.activeTab !== 'drive_logs' && this.activeTab !== 'drive_config' && this.activeTab !== 'git_settings';
    },
    jobs() {
      return this.$root.jobs || [];
    },
    active_job() {
      const job = this.jobs.find(job => job.state === 'running');
      if (job) {
        return job.title;
      }
      return '';
    },
  },
  created() {
    this.fetch();
    this.rootFolder = this.$root.drive;
  },
  watch: {
    async $route() {
      await this.fetch();
      this.activeTab = this.$route.hash.replace(/^#/, '') || DEFAULT_TAB;
    },
    async active_job() {
      if (this.active_job === '') {
        await this.fetch();
        await this.$refs.filesTree.refresh();
      }
    }
  },
  mounted() {
    this.activeTab = this.$route.hash.replace(/^#/, '') || DEFAULT_TAB;
  },
  methods: {
    async fetchFolder(driveId, filePath) {
      const pathContent = await this.FileClientService.getFile('/' + driveId + filePath);
      this.folderPath = filePath;
      this.files = pathContent.files || [];
      this.treeEmpty = pathContent.treeEmpty;
      this.treeRegenerate = pathContent.treeRegenerate;
      return pathContent;
    },
    async fetch() {
      const filePath = this.$route.path.substring('/drive'.length);

      const parts = filePath.split('/').filter(s => s.length > 0);
      const driveId = parts.shift();
      const baseName = parts.pop() || '';

      this.selectedFile = {};

      try {
        if (baseName.indexOf('.') > -1) {
          const dirPath = '/' + parts.join('/');
          await this.fetchFolder(driveId, dirPath);
          const file = this.files.find(f => f.fileName === baseName) || {};
          this.selectedFolder = null;
          this.selectedFile = file || {};
        } else {
          parts.push(baseName);
          const dirPath = '/' + parts.join('/');
          this.selectedFolder = await this.fetchFolder(driveId, dirPath);
          this.selectedFile = {};
        }
        this.notRegistered = false;
      } catch (err) {
        if (err.code === 404) {
          this.shareEmail = err.share_email;
          this.notRegistered = true;
        }
      }
    }
  }
};
</script>
